<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Turni Domenica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  padding: 10px;
  background: #ffffff;
}

h2 {
  font-size: 18px;
  text-align: center;
  margin-bottom: 8px;
}

#istruzioni {
  font-size: 14px;
  text-align: center;
  margin-bottom: 14px;
  line-height: 1.4;
  color: #333;
}

#lista {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
}

button {
  flex: 0 0 calc(33.33% - 12px);
  margin: 5px;
  padding: 12px 6px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background: #f7f7f7;
  box-sizing: border-box;
}

@media (max-width: 500px) {
  button {
    flex: 0 0 calc(50% - 10px);
    font-size: 13px;
  }
}
</style>
</head>

<body>

<h2 style="font-size:20px; text-align:center; line-height:1.3; margin-bottom:10px;">
Come salvare i turni della domenica<br>
sul calendario
</h2>
<div id="istruzioni"></div>
<div id="lista">Caricamentoâ€¦</div>

<script>
// ðŸ”— LINK RAW CSV
const urlCSV = "https://raw.githubusercontent.com/giacjin-max/turni-domenica/refs/heads/main/turni.csv";

// ---------------------
// ISTRUZIONI SEMPLICI
// ---------------------
function mostraIstruzioni(){
  const ua = navigator.userAgent.toLowerCase();
  const box = document.getElementById("istruzioni");

  if (ua.includes("iphone") || ua.includes("ipad")) {
    box.innerHTML =
      "ðŸ“± <b>iPhone</b><br>" +
      "Apri con <b>Safari</b><br>" +
      "Tocca il tuo nome<br>" +
      "Conferma su Calendario";
  }
  else if (ua.includes("android")) {
  box.innerHTML =
    "ðŸ¤– <b>Android</b><br>" +
    "Tocca il tuo nome<br>" +
    "Apri / importa il file<br>" +
    "con <b>Calendario</b>";
  }
  else {
    box.innerHTML =
      "ðŸ’» Tocca il tuo nome<br>" +
      "Aggiungi al calendario";
  }
}

// ---------------------
// UTILITY
// ---------------------
function isCinese(nome){
  return /[^\u0000-\u007F]/.test(nome);
}

function formatICS(d){
  const p = n => n.toString().padStart(2,"0");
  return d.getFullYear() +
         p(d.getMonth()+1) +
         p(d.getDate()) + "T" +
         p(d.getHours()) +
         p(d.getMinutes()) + "00";
}

// ---------------------
// CARICA CSV
// ---------------------
async function caricaNomi(){
  const r = await fetch(urlCSV);
  const t = await r.text();
  const righe = t.split("\n").filter(r=>r.trim());

  if (righe.length < 2) {
    document.getElementById("lista").innerText = "Nessun turno";
    return;
  }

  const titoli = righe[0].split(";").map(x=>x.trim());
  const mappa = new Map();
  const oggi = new Date(); oggi.setHours(0,0,0,0);

  for (let i=1;i<righe.length;i++){
    const celle = righe[i].split(";").map(x=>x.trim());
    if (!celle[0]) continue;

    const [g,m,a] = celle[0].split("/");
    if (!g||!m||!a) continue;

    const data = new Date(a, m-1, g);
    if (data < oggi) continue;

    for (let j=1;j<celle.length;j++){
      if (!celle[j]) continue;
      const servizio = titoli[j];
      celle[j].split(",").forEach(n=>{
        const nome = n.trim();
        if (!nome || isCinese(nome)) return;
        if (!mappa.has(nome)) mappa.set(nome, []);
        mappa.get(nome).push({data, servizio});
      });
    }
  }

  const lista = document.getElementById("lista");
  lista.innerHTML = "";

  [...mappa.keys()].sort().forEach(nome=>{
    const btn = document.createElement("button");
    btn.textContent = nome;
    btn.onclick = ()=>generaICS(nome, mappa.get(nome));
    lista.appendChild(btn);
  });
}

// ---------------------
// CREA FILE ICS
// ---------------------
function generaICS(nome, turni){
  let ics =
`BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

  turni.forEach(t=>{
    const start = new Date(t.data.getFullYear(), t.data.getMonth(), t.data.getDate(), 15, 0);
    const end   = new Date(t.data.getFullYear(), t.data.getMonth(), t.data.getDate(), 18, 0);

    ics +=
`BEGIN:VEVENT
SUMMARY:${t.servizio}
DESCRIPTION:${t.servizio} â€“ ${nome}
DTSTART:${formatICS(start)}
DTEND:${formatICS(end)}
BEGIN:VALARM
TRIGGER:-P6D
ACTION:DISPLAY
DESCRIPTION:Promemoria servizio
END:VALARM
END:VEVENT
`;
  });

  ics += "END:VCALENDAR";

  const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "turni_" + nome + ".ics";
  link.click();
}

// ---------------------
// AVVIO
// ---------------------
mostraIstruzioni();
caricaNomi();
</script>

</body>
</html>