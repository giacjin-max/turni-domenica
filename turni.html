<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Turni Domenica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body style="font-family:Arial; padding:10px; background:#fff">

<h2 style="font-size:16px; margin-bottom:10px;">Tocca il tuo nome per scaricare tutti i tuoi turni</h2>

<div id="lista" style="text-align:center;">Caricamento...</div>

<script>
// ðŸ”´ Link RAW del tuo CSV su GitHub
const urlCSV = "https://raw.githubusercontent.com/giacjin-max/turni-domenica/refs/heads/main/turni.csv";

// ---------- FUNZIONI ----------
function formatDateICS(d){
  const p = n => n.toString().padStart(2,"0");
  return d.getFullYear() + p(d.getMonth()+1) + p(d.getDate()) + "T" + p(d.getHours()) + p(d.getMinutes()) + "00";
}

// ---------- CARICA NOMI (solo con turni futuri) ----------
async function caricaNomi(){
  const r = await fetch(urlCSV);
  const t = await r.text();
  const righe = t.split("\n").filter(x=>x.trim());
  const titoli = righe[0].split(",");
  const nomiMap = new Map();

  const oggi = new Date();
  oggi.setHours(0,0,0,0);

  for(let i=1;i<righe.length;i++){
    const celle = righe[i].split(",");
    const [g,m,a] = celle[0].trim().split("/");
    const dataTurno = new Date(parseInt(a), parseInt(m)-1, parseInt(g));
    if(dataTurno < oggi) continue;

    for(let j=1;j<celle.length;j++){
      if(!celle[j]) continue;
      const servizio = titoli[j] ? titoli[j].trim() : null;
      if(!servizio) continue;
      celle[j].split(/;|\//).forEach(n=>{
        const nome = n.trim();
        if(nome){
          if(!nomiMap.has(nome)) nomiMap.set(nome, []);
          nomiMap.get(nome).push({data: dataTurno, servizio});
        }
      });
    }
  }

  const lista = document.getElementById("lista");
  lista.innerHTML = "";

  [...nomiMap.keys()].sort().forEach(nome=>{
    const btn = document.createElement("button");
    btn.textContent = nome;
    btn.style.display = "inline-block";       
    btn.style.width = "calc(50% - 10px)";     
    btn.style.padding = "8px 10px";           
    btn.style.margin = "5px";                 
    btn.style.fontSize = "14px";              
    btn.style.textAlign = "center";
    btn.style.border = "1px solid #ccc";
    btn.style.borderRadius = "4px";
    btn.style.background = "#f9f9f9";
    btn.style.boxSizing = "border-box";       
    btn.onclick = ()=>generaICS(nome, nomiMap.get(nome));
    lista.appendChild(btn);
  });
}

// ---------- GENERA FILE ICS ----------
function generaICS(nomeUtente, turni){
  let ics = 
`BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

  turni.forEach((t)=>{
    const start = new Date(t.data.getFullYear(), t.data.getMonth(), t.data.getDate(), 15,0,0);
    const end   = new Date(t.data.getFullYear(), t.data.getMonth(), t.data.getDate(), 18,0,0);

    ics += 
`BEGIN:VEVENT
UID:${nomeUtente}_${t.data.getDate()}-${t.data.getMonth()+1}-${t.data.getFullYear()}_${t.servizio}@turnidomenica
SUMMARY:${t.servizio}
DESCRIPTION:${t.servizio} â€“ ${nomeUtente}
DTSTART:${formatDateICS(start)}
DTEND:${formatDateICS(end)}
BEGIN:VALARM
TRIGGER:-P6D
ACTION:DISPLAY
DESCRIPTION:Promemoria servizio
END:VALARM
END:VEVENT
`;
  });

  ics += "END:VCALENDAR";

  const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `turni_${nomeUtente}.ics`;
  link.click();
}

// ---------- AVVIO ----------
caricaNomi();
</script>

</body>
</html>