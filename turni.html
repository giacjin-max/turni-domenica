<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Turni Domenica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body style="font-family:Arial; padding:15px">

<h2>Tocca il tuo nome per salvare i turni</h2>

<div id="lista">Caricamento...</div>

<script>
// ðŸ”´ CAMBIA SOLO QUESTA RIGA
const urlCSV = "https://raw.githubusercontent.com/TuoUsername/tuo-repo/main/turni.csv";

// ---------- FUNZIONI ----------
function formatDateICS(d){
  const p=n=>n<10?'0'+n:n;
  return `${d.getUTCFullYear()}${p(d.getUTCMonth()+1)}${p(d.getUTCDate())}T${p(d.getUTCHours())}${p(d.getUTCMinutes())}00Z`;
}

// ---------- CARICA NOMI ----------
async function caricaNomi(){
  const r = await fetch(urlCSV);
  const t = await r.text();
  const righe = t.split("\n").filter(x=>x.trim());
  const nomiSet = new Set();

  for(let i=1;i<righe.length;i++){
    righe[i].split(",").slice(1).forEach(c=>{
      c.split(",").forEach(n=>{
        if(n.trim()) nomiSet.add(n.trim());
      });
    });
  }

  const lista = document.getElementById("lista");
  lista.innerHTML = "";

  [...nomiSet].sort().forEach(nome=>{
    const btn = document.createElement("button");
    btn.textContent = nome;
    btn.style.display="block";
    btn.style.width="100%";
    btn.style.padding="12px";
    btn.style.margin="8px 0";
    btn.style.fontSize="16px";
    btn.onclick = ()=>generaICS(nome);
    lista.appendChild(btn);
  });
}

// ---------- GENERA FILE ICS ----------
async function generaICS(nomeUtente){
  const r = await fetch(urlCSV);
  const t = await r.text();
  const righe = t.split("\n").filter(x=>x.trim());
  const titoli = righe[0].split(",");

  let ics =
`BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

  let uid=1;

  for(let i=1;i<righe.length;i++){
    const celle = righe[i].split(",");
    const [g,m,a] = celle[0].split("/");
    const start = new Date(Date.UTC(2000+ +a, m-1, g, 10));
    const end = new Date(start.getTime() + 60*60*1000);

    for(let j=1;j<celle.length;j++){
      const nomi = celle[j].split(",").map(n=>n.trim());
      if(nomi.includes(nomeUtente)){
        ics +=
`BEGIN:VEVENT
UID:${uid++}@turnidomenica
SUMMARY:Servizio della domenica
DESCRIPTION:${titoli[j]} â€“ ${nomeUtente}
DTSTART:${formatDateICS(start)}
DTEND:${formatDateICS(end)}
BEGIN:VALARM
TRIGGER:-P6D
ACTION:DISPLAY
DESCRIPTION:Promemoria servizio
END:VALARM
END:VEVENT
`;
      }
    }
  }

  ics += "END:VCALENDAR";

  const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `turni_${nomeUtente}.ics`;
  link.click();
}

// ---------- AVVIO ----------
caricaNomi();
</script>

</body>
</html>